# Implementation Plan: MCP Server & Task Tools

**Branch**: `004-mcp-task-tools`
**Date**: 2025-01-25
**Spec**: [spec.md](./spec.md)
**Input**: SPEC 004 — MCP Server & Task Tools (CONTROL PLANE)

---

## Summary

Implement a stateless MCP server that exposes five task management tools (add_task, list_tasks, complete_task, delete_task, update_task). Each tool operates on the existing Task table via SQLModel, enforces user isolation, and returns structured responses suitable for AI agent consumption.

---

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: FastAPI, SQLModel, MCP SDK (mcp), Pydantic
**Storage**: Neon PostgreSQL (existing database)
**Testing**: pytest, pytest-asyncio
**Target Platform**: Linux server (same as backend)
**Project Type**: MCP tool module integrated with FastAPI backend
**Performance Goals**: < 500ms per tool invocation
**Constraints**: Stateless, user isolation mandatory, no agent logic

---

## Constitution Check

**GATE: Must pass before implementation. All items from Constitution v2.0.0.**

| Principle | Requirement | Plan Compliance |
|-----------|-------------|-----------------|
| §3.1 User Isolation | All queries filter by user_id | ✅ Every tool requires user_id, all SQL filters by user_id |
| §3.2 Stateless Server | No in-memory state | ✅ Fresh DB session per tool, no caching |
| §3.3 No Silent Failures | Friendly error messages | ✅ Standardized ToolError responses |
| §3.4 Auth Boundary | Verify user_id | ⚠️ MCP tools trust caller; agent layer validates JWT |
| §3.5 Natural Language | No IDs in chat | ✅ N/A - tools return data, agent formats for user |

**Result**: ✅ All gates pass (§3.4 responsibility delegated to agent layer per spec)

---

## Project Structure

### Documentation (this feature)

```
specs/004-mcp-task-tools/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Technical decisions
├── data-model.md        # Entity definitions
├── contracts/           # Tool contracts
│   └── mcp-tools.md     # Tool schemas and responses
├── checklists/
│   └── requirements.md  # Quality validation
└── tasks.md             # Implementation tasks (generated by /sp.tasks)
```

### Source Code

```
backend/
├── mcp/
│   ├── __init__.py           # Module exports
│   ├── server.py             # MCP server setup and tool registration
│   ├── tools/
│   │   ├── __init__.py       # Tool exports
│   │   ├── add_task.py       # add_task tool implementation
│   │   ├── list_tasks.py     # list_tasks tool implementation
│   │   ├── complete_task.py  # complete_task tool implementation
│   │   ├── delete_task.py    # delete_task tool implementation
│   │   └── update_task.py    # update_task tool implementation
│   ├── schemas/
│   │   ├── __init__.py       # Schema exports
│   │   ├── params.py         # Tool parameter models
│   │   └── responses.py      # ToolResponse, ToolError models
│   └── crud/
│       ├── __init__.py       # CRUD exports
│       └── task.py           # Task CRUD operations (MCP-specific)
├── tests/
│   └── mcp/
│       ├── __init__.py
│       ├── conftest.py       # MCP test fixtures
│       ├── test_add_task.py
│       ├── test_list_tasks.py
│       ├── test_complete_task.py
│       ├── test_delete_task.py
│       └── test_update_task.py
```

---

## Implementation Steps

### Phase 1: Foundation (Steps 1-4)

#### Step 1: Create MCP Module Structure

**Responsibility**: Set up the directory structure for MCP tools

**Details**:
- Create `backend/mcp/` directory with `__init__.py`
- Create `backend/mcp/tools/` directory
- Create `backend/mcp/schemas/` directory
- Create `backend/mcp/crud/` directory

**Constitution Alignment**: §3.2 (organized, stateless module)

---

#### Step 2: Create Tool Response Schemas

**Responsibility**: Define Pydantic models for tool responses

**Details**:
- File: `backend/mcp/schemas/responses.py`
- Models:
  - `ToolError`: code, message, details
  - `ToolResponse`: success, data, error
  - `TaskData`: serialized task for responses
  - `ListTasksData`: tasks array with total
  - `DeleteTaskData`: deleted confirmation
- All models inherit from Pydantic BaseModel

**Constitution Alignment**: §3.3 (structured error responses)

---

#### Step 3: Create Tool Parameter Schemas

**Responsibility**: Define Pydantic models for tool input validation

**Details**:
- File: `backend/mcp/schemas/params.py`
- Models:
  - `AddTaskParams`: user_id, title, description, priority, due_date
  - `ListTasksParams`: user_id
  - `CompleteTaskParams`: task_id, user_id
  - `DeleteTaskParams`: task_id, user_id
  - `UpdateTaskParams`: task_id, user_id, optional fields
- Validators:
  - Title: non-empty, max 255 chars
  - Priority: enum validation
  - Due date: ISO format validation

**Constitution Alignment**: §3.3 (input validation prevents silent failures)

---

#### Step 4: Create MCP Task CRUD Module

**Responsibility**: Database operations for MCP tools

**Details**:
- File: `backend/mcp/crud/task.py`
- Functions:
  - `create_task(session, user_id, params) → Task`
  - `get_tasks_for_user(session, user_id) → List[Task]`
  - `get_task_by_id_and_user(session, task_id, user_id) → Task | None`
  - `update_task(session, task, updates) → Task`
  - `delete_task(session, task) → None`
- ALL functions filter by user_id
- Uses existing Task model from backend/models/user.py

**Constitution Alignment**: §3.1 (mandatory user_id filtering)

---

### Phase 2: Tool Implementation (Steps 5-9)

#### Step 5: Implement add_task Tool

**Responsibility**: Create new task tool

**Details**:
- File: `backend/mcp/tools/add_task.py`
- Function: `add_task(params: AddTaskParams) → ToolResponse`
- Logic:
  1. Create DB session
  2. Create task with defaults (completed=false, priority=Medium)
  3. Commit and return TaskData
  4. On error, return ToolError
- Database: INSERT into task table

**Constitution Alignment**: §3.1 (user_id in task), §3.2 (fresh session)

---

#### Step 6: Implement list_tasks Tool

**Responsibility**: Retrieve user's tasks tool

**Details**:
- File: `backend/mcp/tools/list_tasks.py`
- Function: `list_tasks(params: ListTasksParams) → ToolResponse`
- Logic:
  1. Create DB session
  2. Query tasks WHERE user_id = params.user_id
  3. Order by created_at DESC
  4. Return ListTasksData (empty array if no tasks)
- Database: SELECT with user_id filter

**Constitution Alignment**: §3.1 (user isolation), §3.2 (no caching)

---

#### Step 7: Implement complete_task Tool

**Responsibility**: Mark task completed tool

**Details**:
- File: `backend/mcp/tools/complete_task.py`
- Function: `complete_task(params: CompleteTaskParams) → ToolResponse`
- Logic:
  1. Create DB session
  2. Lookup task by task_id AND user_id
  3. If not found → return not_found error
  4. Set completed=true, updated_at=now
  5. Return updated TaskData (partial)
- Idempotent: Already completed → return success

**Constitution Alignment**: §3.1 (lookup includes user_id), §3.3 (not_found error)

---

#### Step 8: Implement delete_task Tool

**Responsibility**: Remove task tool

**Details**:
- File: `backend/mcp/tools/delete_task.py`
- Function: `delete_task(params: DeleteTaskParams) → ToolResponse`
- Logic:
  1. Create DB session
  2. Lookup task by task_id AND user_id
  3. If not found → return not_found error
  4. Delete task from database
  5. Return DeleteTaskData

**Constitution Alignment**: §3.1 (user isolation on delete)

---

#### Step 9: Implement update_task Tool

**Responsibility**: Modify task attributes tool

**Details**:
- File: `backend/mcp/tools/update_task.py`
- Function: `update_task(params: UpdateTaskParams) → ToolResponse`
- Logic:
  1. Validate at least one update field provided
  2. Create DB session
  3. Lookup task by task_id AND user_id
  4. If not found → return not_found error
  5. Apply only provided fields
  6. Update updated_at timestamp
  7. Return full TaskData

**Constitution Alignment**: §3.1 (user isolation), §3.2 (fresh read)

---

### Phase 3: Server Setup (Steps 10-11)

#### Step 10: Create MCP Server Module

**Responsibility**: Register tools with MCP SDK

**Details**:
- File: `backend/mcp/server.py`
- Setup:
  - Import MCP SDK
  - Create tool definitions from schemas
  - Register all five tools
  - Export callable tool functions
- Integration point: Agent layer will import and invoke these tools

**Integration Point**: Spec 005 (Agent Loop) will call these tools

---

#### Step 11: Export MCP Module

**Responsibility**: Clean module exports

**Details**:
- File: `backend/mcp/__init__.py`
- Exports:
  - Tool functions: add_task, list_tasks, complete_task, delete_task, update_task
  - Schemas: ToolResponse, ToolError, param models
  - Server setup function (if needed)

---

### Phase 4: Testing (Steps 12-16)

#### Step 12: Create MCP Test Fixtures

**Responsibility**: Shared test setup

**Details**:
- File: `backend/tests/mcp/conftest.py`
- Fixtures:
  - Test database session (SQLite in-memory)
  - Sample user IDs
  - Sample task data
  - Tool invoker helpers

---

#### Step 13: Test add_task Tool

**Responsibility**: Verify add_task behavior

**Details**:
- File: `backend/tests/mcp/test_add_task.py`
- Tests:
  - Create task with required fields only
  - Create task with all fields
  - Empty title returns invalid_input
  - Invalid priority returns invalid_priority
  - Task has correct user_id

---

#### Step 14: Test list_tasks Tool

**Responsibility**: Verify list_tasks behavior

**Details**:
- File: `backend/tests/mcp/test_list_tasks.py`
- Tests:
  - Returns tasks for user
  - Returns empty array for user with no tasks
  - Does not return other user's tasks (isolation)
  - Tasks ordered by created_at DESC

---

#### Step 15: Test complete_task and delete_task Tools

**Responsibility**: Verify modify/delete operations

**Details**:
- File: `backend/tests/mcp/test_complete_task.py`
- File: `backend/tests/mcp/test_delete_task.py`
- Tests:
  - Complete existing task succeeds
  - Complete already-completed task succeeds (idempotent)
  - Complete non-existent task returns not_found
  - Complete other user's task returns not_found
  - Delete existing task succeeds
  - Delete non-existent task returns not_found

---

#### Step 16: Test update_task Tool

**Responsibility**: Verify update behavior

**Details**:
- File: `backend/tests/mcp/test_update_task.py`
- Tests:
  - Update single field succeeds
  - Update multiple fields succeeds
  - No update fields returns invalid_input
  - Invalid priority returns invalid_priority
  - Update non-existent task returns not_found
  - Other user's task returns not_found

---

### Phase 5: Integration (Step 17)

#### Step 17: Final Validation

**Responsibility**: End-to-end verification

**Details**:
- Run all MCP tests
- Verify user isolation across all tools
- Verify stateless behavior (no side effects between calls)
- Verify error response format consistency
- Document any deviations from spec

---

## Dependencies & Execution Order

```
Step 1 (Structure)          ──→ Step 2 (Response Schemas)
                                        │
                                        ▼
                                Step 3 (Param Schemas)
                                        │
                                        ▼
                                Step 4 (CRUD)
                                        │
            ┌───────────────────────────┼───────────────────────────┐
            ▼                           ▼                           ▼
Step 5 (add_task)        Step 6 (list_tasks)        Step 7 (complete_task)
            │                           │                           │
            │                           │                           ▼
            │                           │            Step 8 (delete_task)
            │                           │                           │
            │                           │                           ▼
            │                           │            Step 9 (update_task)
            └───────────────────────────┼───────────────────────────┘
                                        │
                                        ▼
                            Step 10 (MCP Server)
                                        │
                                        ▼
                            Step 11 (Module Export)
                                        │
                                        ▼
                            Step 12 (Test Fixtures)
                                        │
            ┌───────────────────────────┼───────────────────────────┐
            ▼                           ▼                           ▼
Step 13 (add test)    Step 14 (list test)      Step 15 (complete/delete)
                                                        │
                                                        ▼
                                                Step 16 (update test)
                                                        │
                                                        ▼
                                            Step 17 (Validation)
```

**Parallel Opportunities**:
- Steps 5, 6, 7, 8, 9 can run in parallel (after Step 4)
- Steps 13, 14 can run in parallel (after Step 12)

---

## Integration Points for Later Specs

| This Spec | Interface | Later Spec |
|-----------|-----------|------------|
| Tool functions | Python imports | 005 - Agent Loop |
| ToolResponse format | Agent parsing | 005 - Agent Loop |
| user_id parameter | JWT extraction | 005 - Agent Loop |

**Callout**: Agent layer (Spec 005) will:
1. Extract user_id from authenticated JWT
2. Call MCP tools with validated user_id
3. Format ToolResponse for natural language output

---

## Statelessness Guarantees

1. **Fresh session per tool**: Each tool creates its own DB session
2. **No module-level state**: No global variables holding data
3. **Idempotent reads**: list_tasks returns consistent results
4. **No caching**: Every call queries database fresh

---

## Callouts

⚠️ **Agent Logic Not Included**: This spec implements ONLY the tool execution layer. The agent that decides WHEN to call tools and HOW to present results is Spec 005.

⚠️ **Authentication Delegated**: MCP tools trust the user_id parameter. The agent layer MUST validate JWT and extract user_id before calling tools.

⚠️ **Existing Task Table**: Tools operate on the existing Task model from Phase II. No schema migration needed.

---

## Ready for Tasks

This plan is ready for `/sp.tasks` to generate implementable task list.
